import{d as H,h as S,c as k,a as t,t as $,g as f,_ as R,r as b,l as O,f as g,w as _,v as T,b as a,I as z,e as D,x as A,y as J,z as K,q as P,j as q,E as U,o as N,F as E,n as Q,p as G,A as X,k as Z}from"./index-B2Hze045.js";import{P as tt}from"./index-Dj1NVCHS.js";import{h as v,_ as et,f as st}from"./Form.vue_vue_type_script_setup_true_lang-CmOriPjR.js";import{R as at,A as B,F as nt,s as ot}from"./chatUtil-oYKybORo.js";import{h as j}from"./request-cIyc3Ouv.js";import"./index-DBMBxV-i.js";const lt={class:"time-display"},it={class:"value"},rt=H({__name:"index",props:{label:{},time:{}},setup(x){const r=x,n=S(()=>{if(!r.time)return"-";try{return v(r.time).format("YYYY-MM-DD HH:mm:ss")}catch{return r.time}});return(c,l)=>(f(),k("div",lt,[t("span",it,$(n.value),1)]))}}),F=R(rt,[["__scopeId","data-v-bd0d80d2"]]),dt={class:"drawer-header"},ut={class:"header-content"},ct={class:"header-title"},mt={class:"drawer-content"},_t={class:"replay-container"},pt={key:1,class:"loading-placeholder"},ft=H({__name:"TaskReplayDrawer",setup(x,{expose:r}){const n=b(!1);let c;const l=b(null),d=S(()=>l.value?`回放任务: ${l.value.name}`:"任务回放"),M=async i=>{i&&(l.value=i,n.value=!0,await p())},p=async()=>{l.value&&(c=new B(l.value.agentId),c&&c.replay(l.value.sessionId))};return r({show:M}),(i,u)=>{const o=g("el-empty"),y=g("el-drawer");return f(),O(y,{modelValue:n.value,"onUpdate:modelValue":u[0]||(u[0]=s=>n.value=s),title:d.value,direction:"rtl",size:"80%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!0,"append-to-body":!0},{header:_(()=>[t("div",dt,[t("div",ut,[a(z,{name:"mdiPlayCircle",size:"medium",class:"header-icon"}),t("span",ct,$(d.value),1)])])]),default:_(()=>[t("div",mt,[t("div",_t,[T(c)?(f(),O(at,{key:0,agentRuntime:T(c)},null,8,["agentRuntime"])):(f(),k("div",pt,[a(o,{description:"正在加载回放数据..."})]))])])]),_:1},8,["modelValue","title"])}}}),vt=R(ft,[["__scopeId","data-v-2a629534"]]),gt={class:"status-display"},yt=H({__name:"index",props:{status:{}},setup(x){const r=x,n=l=>({waiting:"info",running:"warning",success:"success",failed:"danger"})[l]||"info",c=l=>({waiting:"等待处理",running:"执行中",success:"已完成",failed:"执行失败"})[l]||"未知";return(l,d)=>{const M=g("el-tag");return f(),k("div",gt,[a(M,{type:n(r.status),size:"small"},{default:_(()=>[D($(c(r.status)),1)]),_:1},8,["type"])])}}}),Yt=R(yt,[["__scopeId","data-v-1d3d913c"]]),kt={class:"task-info-content"},ht={class:"info-section"},Dt={class:"section-title"},$t={class:"info-grid"},Mt={class:"info-item"},bt={class:"value"},wt={class:"info-item"},zt={class:"value"},xt={class:"info-item"},Tt={class:"info-section"},Ct={class:"section-title"},Vt={key:0,class:"agent-info"},Ht={class:"info-item"},Rt={class:"value"},It={class:"info-item"},St={class:"value"},Ot={key:1,class:"no-data"},qt={class:"info-section"},Ut={class:"section-title"},Ft={key:0,class:"task-form"},Nt={key:1,class:"no-data"},At={class:"info-section"},Et={class:"section-title"},Bt={key:0,class:"files-container"},jt={key:1,class:"no-data"},Lt=H({__name:"TaskInfoDrawer",setup(x,{expose:r}){const n=b(!1);let c;const l=b(null),d=b(null),M=S(()=>d.value?.name||"任务详情"),p=async u=>{d.value=u,n.value=!0,c=new B(u.agentId),l.value=u.request?JSON.parse(u.request):{}},i=()=>{n.value=!1,c=void 0,l.value=null,d.value=null};return r({show:p}),(u,o)=>{const y=g("el-icon"),s=g("el-empty"),e=g("el-drawer");return f(),O(e,{modelValue:n.value,"onUpdate:modelValue":o[0]||(o[0]=m=>n.value=m),title:M.value,direction:"rtl",size:"60%","append-to-body":!0,"before-close":i},{default:_(()=>[t("div",kt,[t("div",ht,[t("h3",Dt,[a(y,null,{default:_(()=>[a(T(A))]),_:1}),o[1]||(o[1]=D(" 任务信息 ",-1))]),t("div",$t,[t("div",Mt,[o[2]||(o[2]=t("span",{class:"label"},"任务名称：",-1)),t("span",bt,$(d.value?.name||"-"),1)]),t("div",wt,[o[3]||(o[3]=t("span",{class:"label"},"会话ID：",-1)),t("span",zt,$(d.value?.sessionId||"-"),1)]),t("div",xt,[o[4]||(o[4]=t("span",{class:"label"},"状态：",-1)),a(Yt,{status:d.value?.status||"waiting"},null,8,["status"])]),a(F,{label:"开始时间",time:d.value?.startTime},null,8,["time"]),a(F,{label:"结束时间",time:d.value?.finishTime},null,8,["time"])])]),t("div",Tt,[t("h3",Ct,[a(y,null,{default:_(()=>[a(T(J))]),_:1}),o[5]||(o[5]=D(" 智能体信息 ",-1))]),T(c)?.agent?.value?(f(),k("div",Vt,[t("div",Ht,[o[6]||(o[6]=t("span",{class:"label"},"名称：",-1)),t("span",Rt,$(T(c).agent.value.name||"-"),1)]),t("div",It,[o[7]||(o[7]=t("span",{class:"label"},"描述：",-1)),t("span",St,$(T(c).agent.value.description||"-"),1)])])):(f(),k("div",Ot,[a(s,{description:"暂无智能体信息"})]))]),t("div",qt,[t("h3",Ut,[a(y,null,{default:_(()=>[a(T(A))]),_:1}),o[8]||(o[8]=D(" 任务信息 ",-1))]),T(c)?.agentInputConfig?.value?(f(),k("div",Ft,[a(et,{ref:"inputFormRef",config:T(c).agentInputConfig.value,data:l.value,style:{width:"100%"}},null,8,["config","data"])])):(f(),k("div",Nt,[a(s,{description:"暂无任务信息"})]))]),t("div",At,[t("h3",Et,[a(y,null,{default:_(()=>[a(T(K))]),_:1}),o[9]||(o[9]=D(" 文件列表 ",-1))]),d.value?.files&&d.value.files.length>0?(f(),k("div",Bt,[a(nt,{files:d.value.files,"session-id":d.value.sessionId},null,8,["files","session-id"])])):(f(),k("div",jt,[a(s,{description:"暂无文件"})]))])])]),_:1},8,["modelValue","title"])}}}),Wt=R(Lt,[["__scopeId","data-v-1babd04e"]]),Jt={class:"task-main"},Kt={class:"task-header"},Pt={class:"task-title"},Qt={class:"task-status"},Gt={class:"task-request"},Xt=["innerHTML"],Zt={class:"task-meta"},te={class:"meta-left"},ee={class:"task-time"},se={key:0,class:"task-duration"},ae={class:"task-actions"},ne=H({__name:"TaskItem",props:{task:{}},setup(x){const r=x,n=b(null),c=b(null),l=S(()=>{const s=r.task?.request;if(!s)return"";try{const e=JSON.parse(s);if(typeof e=="object"&&e!==null&&!Array.isArray(e)){const m=Object.keys(e);if(!m.includes("query"))return s;if(m.filter(Y=>Y!=="query"&&!Y.startsWith("_")).length===0){let Y=`<div>${e.query}</div>`;for(const C of m){if(!C.startsWith("_"))continue;const I=e[C];if(!Array.isArray(I))break;Y+='<div style="margin-top: 8px;"><strong>文件列表:</strong></div>',Y+='<ul style="margin: 4px 0; padding-left: 20px;">';for(const h of I)if(typeof h=="object"&&h!==null&&"id"in h&&"name"in h){const V=h.name||"未知文件",L=h.size?st(h.size):"未知大小",W=h.description?` - ${h.description}`:"";Y+=`<li style="margin: 2px 0;">${V} (${L})${W}</li>`}Y+="</ul>"}return Y}}return s}catch{return s}}),d=S(()=>{const{startTime:s,finishTime:e}=r.task;if(!s||!e)return"";try{const m=v(s,"YYYY/MM/DD HH:mm:ss"),w=v(e,"YYYY/MM/DD HH:mm:ss"),Y=v.duration(w.diff(m)),C=Math.floor(Y.asHours()),I=Y.minutes(),h=Y.seconds();let V="";return C>0&&(V+=`${C}h`),I>0&&(V+=`${I}m`),h>0&&(V+=`${h}s`),V||(V="0s"),V}catch(m){return console.error("计算持续时间失败:",m),""}}),M=async()=>{await c.value?.show(r.task)},p=async()=>{await n.value?.show(r.task)},i=async()=>{if(!r.task.sessionId){U.error("任务会话ID不存在，无法停止");return}await ot(r.task.sessionId)&&U.success(`已发送停止请求: ${r.task.name}`)},u=s=>`status-${s}`,o=s=>({waiting:"info",running:"warning",success:"success",failed:"danger"})[s]||"info",y=s=>({waiting:"等待处理",running:"执行中",success:"已完成",failed:"执行失败"})[s]||"未知";return(s,e)=>{const m=g("el-tag"),w=g("el-button");return f(),k("div",{class:P(["task-item",u(s.task.status)])},[t("div",Jt,[t("div",Kt,[t("div",Pt,[D($(s.task.name)+" ",1),s.task.mode==="SCHEDULER"?(f(),O(m,{key:0,type:"info",size:"small",class:"mode-tag"},{default:_(()=>[...e[0]||(e[0]=[D(" 定时任务 ",-1)])]),_:1})):q("",!0)]),t("div",Qt,[a(m,{type:o(s.task.status),size:"small"},{default:_(()=>[D($(y(s.task.status)),1)]),_:1},8,["type"])])]),t("div",Gt,[t("div",{class:"request-text",innerHTML:l.value},null,8,Xt)]),t("div",Zt,[t("div",te,[t("div",ee,[a(z,{name:"mdiClock",size:"small"}),a(F,{label:"",time:s.task.startTime},null,8,["time"])]),d.value?(f(),k("div",se,[a(z,{name:"mdiTimer",size:"small"}),D(" "+$(d.value),1)])):q("",!0)]),t("div",ae,[a(w,{size:"small",type:"primary",onClick:M},{default:_(()=>[...e[1]||(e[1]=[D(" 查看 ",-1)])]),_:1}),a(w,{size:"small",type:"default",onClick:p},{default:_(()=>[...e[2]||(e[2]=[D(" 回放 ",-1)])]),_:1}),s.task.status==="running"?(f(),O(w,{key:0,size:"small",type:"danger",onClick:i},{default:_(()=>[...e[3]||(e[3]=[D(" 停止 ",-1)])]),_:1})):q("",!0)])])]),a(vt,{ref_key:"taskReplayDrawerRef",ref:n},null,512),a(Wt,{ref_key:"taskInfoDrawerRef",ref:c},null,512)],2)}}}),oe=R(ne,[["__scopeId","data-v-2834a38b"]]),le={class:"stats-section"},ie={class:"stats-header"},re={class:"date-selector"},de={class:"current-date-range"},ue={class:"date-range-text"},ce={class:"stats-grid"},me={class:"stat-card"},_e={class:"stat-icon running"},pe={class:"stat-content"},fe={class:"stat-number"},ve={class:"stat-card"},ge={class:"stat-icon success"},ye={class:"stat-content"},Ye={class:"stat-number"},ke={class:"stat-card"},he={class:"stat-icon failed"},De={class:"stat-content"},$e={class:"stat-number"},Me={class:"stat-card"},be={class:"stat-icon waiting"},we={class:"stat-content"},ze={class:"stat-number"},xe={class:"custom-date-dialog"},Te={class:"date-picker-row"},Ce={class:"dialog-footer"},Ve=H({__name:"TaskStats",setup(x){const r=b({}),n=S(()=>r.value.running||0+r.value.success||0+r.value.failed||0),c=b("today"),l=b(null),d=b(!1),M=S(()=>{if(c.value==="custom"){if(l.value&&l.value.length===2){const[e,m]=l.value;return`${e} 至 ${m}`}return"请选择时间范围"}const s=p[c.value]();return s.start&&s.end?`${s.start} 至 ${s.end}`:"全部时间"}),p={today:()=>{const s=v().startOf("day").format("YYYY/MM/DD HH:mm:ss"),e=v().add(1,"day").startOf("day").format("YYYY/MM/DD HH:mm:ss");return{start:s,end:e}},yesterday:()=>{const s=v().subtract(1,"day").startOf("day").format("YYYY/MM/DD HH:mm:ss"),e=v().startOf("day").format("YYYY/MM/DD HH:mm:ss");return{start:s,end:e}},week:()=>{const s=v().startOf("week").format("YYYY/MM/DD HH:mm:ss"),e=v().add(1,"week").startOf("week").format("YYYY/MM/DD HH:mm:ss");return{start:s,end:e}},month:()=>{const s=v().startOf("month").format("YYYY/MM/DD HH:mm:ss"),e=v().add(1,"month").startOf("month").format("YYYY/MM/DD HH:mm:ss");return{start:s,end:e}},all:()=>({start:void 0,end:void 0})},i=s=>{if(console.log("Date range changed to:",s),s==="custom"){d.value=!0;return}try{const e=p[s]();y(e.start,e.end)}catch(e){console.error("Error in handleDateRangeChange:",e)}},u=()=>{d.value=!1,c.value="today",l.value=null},o=()=>{if(l.value&&l.value.length===2){const[s,e]=l.value;y(s,e),d.value=!1}};async function y(s,e){const m={};s&&(m.startTime=s),e&&(m.endTime=e);const w=await j.get("/task/summarize",{params:m});r.value=w.data}return N(()=>{const s=p.today();y(s.start,s.end)}),(s,e)=>{const m=g("el-option"),w=g("el-select"),Y=g("el-date-picker"),C=g("el-button"),I=g("el-dialog");return f(),k(E,null,[t("div",le,[t("div",ie,[t("div",re,[t("div",de,[e[3]||(e[3]=t("span",{class:"date-range-label"},"当前范围：",-1)),t("span",ue,$(M.value),1)]),a(w,{modelValue:c.value,"onUpdate:modelValue":e[0]||(e[0]=h=>c.value=h),onChange:i,size:"small",style:{width:"120px"}},{default:_(()=>[a(m,{label:"今天",value:"today"}),a(m,{label:"昨天",value:"yesterday"}),a(m,{label:"本周",value:"week"}),a(m,{label:"本月",value:"month"}),a(m,{label:"全部",value:"all"}),a(m,{label:"定制",value:"custom"})]),_:1},8,["modelValue"])])]),t("div",ce,[t("div",me,[t("div",_e,[a(z,{name:"mdiPlayCircle",size:"large"})]),t("div",pe,[t("div",fe,$(r.value.running||0),1),e[4]||(e[4]=t("div",{class:"stat-label"},"执行中",-1))])]),t("div",ve,[t("div",ge,[a(z,{name:"mdiCheckCircle",size:"large"})]),t("div",ye,[t("div",Ye,$(r.value.success||0),1),e[5]||(e[5]=t("div",{class:"stat-label"},"已完成",-1))])]),t("div",ke,[t("div",he,[a(z,{name:"mdiCloseCircle",size:"large"})]),t("div",De,[t("div",$e,$(r.value.failed||0),1),e[6]||(e[6]=t("div",{class:"stat-label"},"执行失败",-1))])]),t("div",Me,[t("div",be,[a(z,{name:"mdiClock",size:"large"})]),t("div",we,[t("div",ze,$(n.value),1),e[7]||(e[7]=t("div",{class:"stat-label"},"全部",-1))])])])]),a(I,{modelValue:d.value,"onUpdate:modelValue":e[2]||(e[2]=h=>d.value=h),title:"选择日期范围",width:"640px","before-close":u},{footer:_(()=>[t("div",Ce,[a(C,{onClick:u},{default:_(()=>[...e[9]||(e[9]=[D("取消",-1)])]),_:1}),a(C,{type:"primary",onClick:o,disabled:!l.value||l.value.length!==2},{default:_(()=>[...e[10]||(e[10]=[D(" 确定 ",-1)])]),_:1},8,["disabled"])])]),default:_(()=>[t("div",xe,[t("div",Te,[e[8]||(e[8]=t("label",{class:"date-label"},"时间范围：",-1)),a(Y,{modelValue:l.value,"onUpdate:modelValue":e[1]||(e[1]=h=>l.value=h),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY/MM/DD HH:mm:ss","value-format":"YYYY/MM/DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue"])])])]),_:1},8,["modelValue"])],64)}}}),He=R(Ve,[["__scopeId","data-v-b82b673c"]]),Re={class:"filter-section"},Ie={class:"form-content"},Se=H({__name:"TaskFilter",props:{modelValue:{},modelModifiers:{}},emits:Q(["query"],["update:modelValue"]),setup(x,{emit:r}){const n=G(x,"modelValue"),c=[{text:"今天",value:()=>{const p=v().format("YYYY-MM-DD 00:00:00"),i=v().add(1,"day").format("YYYY-MM-DD 00:00:00");return[p,i]}},{text:"昨天",value:()=>{const p=v().subtract(1,"day").format("YYYY-MM-DD 00:00:00"),i=v().format("YYYY-MM-DD 00:00:00");return[p,i]}},{text:"前天",value:()=>{const p=v().subtract(2,"day").format("YYYY-MM-DD 00:00:00"),i=v().subtract(1,"day").format("YYYY-MM-DD 00:00:00");return[p,i]}},{text:"本周",value:()=>{const p=v().startOf("week").format("YYYY-MM-DD 00:00:00"),i=v().add(1,"week").startOf("week").format("YYYY-MM-DD 00:00:00");return[p,i]}},{text:"本月",value:()=>{const p=v().startOf("month").format("YYYY-MM-DD 00:00:00"),i=v().add(1,"month").startOf("month").format("YYYY-MM-DD 00:00:00");return[p,i]}}],l=r,d=()=>{l("query")},M=()=>{n.value.name="",n.value.status="";const p=v().format("YYYY-MM-DD 00:00:00"),i=v().add(1,"day").format("YYYY-MM-DD 00:00:00");n.value.dateRange=[p,i]};return N(()=>M()),(p,i)=>{const u=g("el-input"),o=g("el-form-item"),y=g("el-option"),s=g("el-select"),e=g("el-date-picker"),m=g("el-button"),w=g("el-form");return f(),k("div",Re,[a(w,{model:n.value,class:"filter-form"},{default:_(()=>[t("div",Ie,[a(o,null,{default:_(()=>[a(u,{modelValue:n.value.name,"onUpdate:modelValue":i[0]||(i[0]=Y=>n.value.name=Y),placeholder:"搜索任务名称...",clearable:""},{prefix:_(()=>[a(z,{name:"magnify",size:"small"})]),_:1},8,["modelValue"])]),_:1}),a(o,null,{default:_(()=>[a(s,{modelValue:n.value.status,"onUpdate:modelValue":i[1]||(i[1]=Y=>n.value.status=Y),placeholder:"状态筛选",clearable:"",style:{width:"320px"}},{default:_(()=>[a(y,{label:"全部",value:""}),a(y,{label:"执行中",value:"running"}),a(y,{label:"已完成",value:"success"}),a(y,{label:"执行失败",value:"failed"}),a(y,{label:"等待处理",value:"waiting"})]),_:1},8,["modelValue"])]),_:1}),a(o,null,{default:_(()=>[a(e,{modelValue:n.value.dateRange,"onUpdate:modelValue":i[2]||(i[2]=Y=>n.value.dateRange=Y),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",shortcuts:c},null,8,["modelValue"])]),_:1}),a(o,null,{default:_(()=>[a(m,{type:"primary",onClick:d},{default:_(()=>[a(z,{name:"magnify",size:"small"}),i[3]||(i[3]=D(" 查询 ",-1))]),_:1}),a(m,{onClick:M},{default:_(()=>[a(z,{name:"mdiFilter",size:"small"}),i[4]||(i[4]=D(" 重置条件 ",-1))]),_:1})]),_:1})])]),_:1},8,["model"])])}}}),Oe=R(Se,[["__scopeId","data-v-e30ccaeb"]]),qe={class:"task-management-page"},Ue={class:"task-list-section"},Fe={class:"task-list"},Ne={key:0,class:"loading-state"},Ae={key:1,class:"empty-state"},Ee={key:2,class:"task-items"},Be={key:0,class:"pagination-section"},je=H({__name:"index",setup(x){const r=b(!1),n=X({total:-1,page:1,size:parseInt(localStorage.getItem("page-size-task")||"10")}),c=b({sortBy:"_insertTime",sortType:"desc"}),l=b([]),d=()=>{n.page=1,n.total=-1,p()};function M(){p(),localStorage.setItem("page-size-task",""+n.size)}async function p(i=!1){i&&(n.total=-1);const u={page:n.page,size:n.size,total:n.total,criteria:JSON.stringify(c.value||{})};try{r.value=!0;const o=await j.get("/task/query",{params:u});o.data&&o.data.list?(l.value=o.data.list,n.size=o.data.size,n.page=o.data.page,n.total=o.data.total):(l.value=[],n.page=1,n.total=-1)}catch(o){console.error("获取任务数据失败:",o),U.error("获取任务数据失败")}finally{r.value=!1}}return N(()=>d()),(i,u)=>{const o=g("el-icon"),y=g("el-pagination");return f(),k("div",qe,[a(tt,{title:"任务管理",icon:"clipboard-list"}),a(He,{tasks:l.value},null,8,["tasks"]),a(Oe,{modelValue:c.value,"onUpdate:modelValue":u[0]||(u[0]=s=>c.value=s),onQuery:d},null,8,["modelValue"]),t("div",Ue,[u[6]||(u[6]=t("div",{class:"list-header"},[t("h3",{class:"list-title"},"任务列表")],-1)),t("div",Fe,[r.value?(f(),k("div",Ne,[a(o,{class:"is-loading"},{default:_(()=>[a(z,{name:"mdiLoading"})]),_:1}),u[3]||(u[3]=t("span",null,"加载中...",-1))])):l.value.length===0?(f(),k("div",Ae,[a(z,{name:"clipboard-list-outline",size:"xlarge",class:"empty-icon"}),u[4]||(u[4]=t("h3",null,"暂无任务",-1)),u[5]||(u[5]=t("p",null,"当前没有找到符合条件的任务",-1))])):(f(),k("div",Ee,[(f(!0),k(E,null,Z(l.value,s=>(f(),O(oe,{key:s._id,task:s},null,8,["task"]))),128))]))]),n.total>0?(f(),k("div",Be,[n.total>0?(f(),O(y,{key:0,"current-page":n.page,"onUpdate:currentPage":u[1]||(u[1]=s=>n.page=s),"page-size":n.size,"onUpdate:pageSize":u[2]||(u[2]=s=>n.size=s),total:n.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:M,onCurrentChange:p},null,8,["current-page","page-size","total"])):q("",!0)])):q("",!0)])])}}}),Ge=R(je,[["__scopeId","data-v-aa1f933a"]]);export{Ge as default};
