import{d as R,h as S,c as Y,a as e,t as $,g as f,_ as I,r as b,l as O,f as g,w as _,v as x,b as a,I as z,e as D,x as A,y as J,z as P,q as K,j as q,E as U,o as N,F as E,n as Q,p as G,A as X,k as Z}from"./index-FPnQycga.js";import{P as ee}from"./index-BkCG6ryb.js";import{h as v,_ as te,f as se}from"./Form.vue_vue_type_script_setup_true_lang-dgRmH8Gp.js";import{R as ae,A as B,F as ne,s as oe}from"./chatUtil-Cj90REbz.js";import{h as j}from"./request-DQlLT5HJ.js";import"./index-CJGsZFYU.js";const le={class:"time-display"},ie={class:"label"},re={class:"value"},de=R({__name:"index",props:{label:{},time:{}},setup(T){const r=T,n=S(()=>{if(!r.time)return"-";try{return v(r.time).format("YYYY-MM-DD HH:mm:ss")}catch{return r.time}});return(d,l)=>(f(),Y("div",le,[e("span",ie,$(d.label)+"：",1),e("span",re,$(n.value),1)]))}}),F=I(de,[["__scopeId","data-v-507e80bc"]]),ue={class:"drawer-header"},ce={class:"header-content"},me={class:"header-title"},_e={class:"drawer-content"},pe={class:"replay-container"},fe={key:1,class:"loading-placeholder"},ve=R({__name:"TaskReplayDrawer",setup(T,{expose:r}){const n=b(!1);let d;const l=b(null),u=S(()=>l.value?`回放任务: ${l.value.name}`:"任务回放"),M=async i=>{i&&(l.value=i,n.value=!0,await p())},p=async()=>{l.value&&(d=new B(l.value.agentId),d&&d.replay(l.value.sessionId))};return r({show:M}),(i,c)=>{const o=g("el-empty"),y=g("el-drawer");return f(),O(y,{modelValue:n.value,"onUpdate:modelValue":c[0]||(c[0]=s=>n.value=s),title:u.value,direction:"rtl",size:"80%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!0,"append-to-body":!0},{header:_(()=>[e("div",ue,[e("div",ce,[a(z,{name:"mdiPlayCircle",size:"medium",class:"header-icon"}),e("span",me,$(u.value),1)])])]),default:_(()=>[e("div",_e,[e("div",pe,[x(d)?(f(),O(ae,{key:0,agentRuntime:x(d)},null,8,["agentRuntime"])):(f(),Y("div",fe,[a(o,{description:"正在加载回放数据..."})]))])])]),_:1},8,["modelValue","title"])}}}),ge=I(ve,[["__scopeId","data-v-2a629534"]]),ye={class:"status-display"},ke=R({__name:"index",props:{status:{}},setup(T){const r=T,n=l=>({waiting:"info",running:"warning",success:"success",failed:"danger"})[l]||"info",d=l=>({waiting:"等待处理",running:"执行中",success:"已完成",failed:"执行失败"})[l]||"未知";return(l,u)=>{const M=g("el-tag");return f(),Y("div",ye,[a(M,{type:n(r.status),size:"small"},{default:_(()=>[D($(d(r.status)),1)]),_:1},8,["type"])])}}}),Ye=I(ke,[["__scopeId","data-v-1d3d913c"]]),he={class:"task-info-content"},De={class:"info-section"},$e={class:"section-title"},Me={class:"info-grid"},be={class:"info-item"},we={class:"value"},ze={class:"info-item"},Te={class:"value"},xe={class:"info-item"},Ce={class:"info-section"},Ve={class:"section-title"},He={key:0,class:"agent-info"},Re={class:"info-item"},Ie={class:"value"},Se={class:"info-item"},Oe={class:"value"},qe={key:1,class:"no-data"},Ue={class:"info-section"},Fe={class:"section-title"},Ne={key:0,class:"task-form"},Ae={key:1,class:"no-data"},Ee={class:"info-section"},Be={class:"section-title"},je={key:0,class:"files-container"},Le={key:1,class:"no-data"},We=R({__name:"TaskInfoDrawer",setup(T,{expose:r}){const n=b(!1);let d;const l=b(null),u=b(null),M=S(()=>u.value?.name||"任务详情"),p=async c=>{u.value=c,n.value=!0,d=new B(c.agentId),l.value=c.request?JSON.parse(c.request):{}},i=()=>{n.value=!1,d=void 0,l.value=null,u.value=null};return r({show:p}),(c,o)=>{const y=g("el-icon"),s=g("el-empty"),t=g("el-drawer");return f(),O(t,{modelValue:n.value,"onUpdate:modelValue":o[0]||(o[0]=m=>n.value=m),title:M.value,direction:"rtl",size:"60%","append-to-body":!0,"before-close":i},{default:_(()=>[e("div",he,[e("div",De,[e("h3",$e,[a(y,null,{default:_(()=>[a(x(A))]),_:1}),o[1]||(o[1]=D(" 基本信息 ",-1))]),e("div",Me,[e("div",be,[o[2]||(o[2]=e("span",{class:"label"},"任务名称：",-1)),e("span",we,$(u.value?.name||"-"),1)]),e("div",ze,[o[3]||(o[3]=e("span",{class:"label"},"会话ID：",-1)),e("span",Te,$(u.value?.sessionId||"-"),1)]),e("div",xe,[o[4]||(o[4]=e("span",{class:"label"},"状态：",-1)),a(Ye,{status:u.value?.status||"waiting"},null,8,["status"])]),a(F,{label:"开始时间",time:u.value?.startTime},null,8,["time"]),a(F,{label:"结束时间",time:u.value?.finishTime},null,8,["time"])])]),e("div",Ce,[e("h3",Ve,[a(y,null,{default:_(()=>[a(x(J))]),_:1}),o[5]||(o[5]=D(" 智能体信息 ",-1))]),x(d)?.agent?.value?(f(),Y("div",He,[e("div",Re,[o[6]||(o[6]=e("span",{class:"label"},"名称：",-1)),e("span",Ie,$(x(d).agent.value.name||"-"),1)]),e("div",Se,[o[7]||(o[7]=e("span",{class:"label"},"描述：",-1)),e("span",Oe,$(x(d).agent.value.description||"-"),1)])])):(f(),Y("div",qe,[a(s,{description:"暂无智能体信息"})]))]),e("div",Ue,[e("h3",Fe,[a(y,null,{default:_(()=>[a(x(A))]),_:1}),o[8]||(o[8]=D(" 任务信息 ",-1))]),x(d)?.agentInputConfig?.value?(f(),Y("div",Ne,[a(te,{ref:"inputFormRef",config:x(d).agentInputConfig.value,data:l.value,disabledParent:!0,style:{width:"100%"}},null,8,["config","data"])])):(f(),Y("div",Ae,[a(s,{description:"暂无任务信息"})]))]),e("div",Ee,[e("h3",Be,[a(y,null,{default:_(()=>[a(x(P))]),_:1}),o[9]||(o[9]=D(" 文件列表 ",-1))]),u.value?.files&&u.value.files.length>0?(f(),Y("div",je,[a(ne,{files:u.value.files,"session-id":u.value.sessionId},null,8,["files","session-id"])])):(f(),Y("div",Le,[a(s,{description:"暂无文件"})]))])])]),_:1},8,["modelValue","title"])}}}),Je=I(We,[["__scopeId","data-v-e52e43a8"]]),Pe={class:"task-main"},Ke={class:"task-header"},Qe={class:"task-title"},Ge={class:"task-status"},Xe={class:"task-request"},Ze=["innerHTML"],et={class:"task-meta"},tt={class:"meta-left"},st={class:"task-time"},at={key:0,class:"task-duration"},nt={class:"task-actions"},ot=R({__name:"TaskItem",props:{task:{}},setup(T){const r=T,n=b(null),d=b(null),l=S(()=>{const s=r.task?.request;if(!s)return"";try{const t=JSON.parse(s);if(typeof t=="object"&&t!==null&&!Array.isArray(t)){const m=Object.keys(t);if(!m.includes("query"))return s;if(m.filter(k=>k!=="query"&&!k.startsWith("_")).length===0){let k=`<div>${t.query}</div>`;for(const C of m){if(!C.startsWith("_"))continue;const V=t[C];if(!Array.isArray(V)||V.length==0)break;k+='<div style="margin-top: 8px;"><strong>文件列表:</strong></div>',k+='<ul style="margin: 4px 0; padding-left: 20px;">';for(const h of V)if(typeof h=="object"&&h!==null&&"id"in h&&"name"in h){const H=h.name||"未知文件",L=h.size?se(h.size):"未知大小",W=h.description?` - ${h.description}`:"";k+=`<li style="margin: 2px 0;">${H} (${L})${W}</li>`}k+="</ul>"}return k}}return s}catch{return s}}),u=S(()=>{const{startTime:s,finishTime:t}=r.task;if(!s||!t)return"";try{const m=v(s,"YYYY/MM/DD HH:mm:ss"),w=v(t,"YYYY/MM/DD HH:mm:ss"),k=v.duration(w.diff(m)),C=Math.floor(k.asHours()),V=k.minutes(),h=k.seconds();let H="";return C>0&&(H+=`${C}h`),V>0&&(H+=`${V}m`),h>0&&(H+=`${h}s`),H||(H="0s"),H}catch(m){return console.error("计算持续时间失败:",m),""}}),M=async()=>{await d.value?.show(r.task)},p=async()=>{await n.value?.show(r.task)},i=async()=>{if(!r.task.sessionId){U.error("任务会话ID不存在，无法停止");return}await oe(r.task.sessionId)&&U.success(`已发送停止请求: ${r.task.name}`)},c=s=>`status-${s}`,o=s=>({waiting:"info",running:"warning",success:"success",failed:"danger"})[s]||"info",y=s=>({waiting:"等待处理",running:"执行中",success:"已完成",failed:"执行失败"})[s]||"未知";return(s,t)=>{const m=g("el-tag"),w=g("el-button");return f(),Y("div",{class:K(["task-item",c(s.task.status)])},[e("div",Pe,[e("div",Ke,[e("div",Qe,[D($(s.task.name)+" ",1),s.task.mode==="SCHEDULER"?(f(),O(m,{key:0,type:"info",size:"small",class:"mode-tag"},{default:_(()=>[...t[0]||(t[0]=[D(" 定时任务 ",-1)])]),_:1})):q("",!0)]),e("div",Ge,[a(m,{type:o(s.task.status),size:"small"},{default:_(()=>[D($(y(s.task.status)),1)]),_:1},8,["type"])])]),e("div",Xe,[e("div",{class:"request-text",innerHTML:l.value},null,8,Ze)]),e("div",et,[e("div",tt,[e("div",st,[a(z,{name:"mdiClock",size:"small"}),a(F,{label:"",time:s.task.startTime},null,8,["time"])]),u.value?(f(),Y("div",at,[a(z,{name:"mdiTimer",size:"small"}),D(" "+$(u.value),1)])):q("",!0)]),e("div",nt,[a(w,{size:"small",type:"primary",onClick:M},{default:_(()=>[...t[1]||(t[1]=[D(" 查看 ",-1)])]),_:1}),a(w,{size:"small",type:"default",onClick:p},{default:_(()=>[...t[2]||(t[2]=[D(" 回放 ",-1)])]),_:1}),s.task.status==="running"?(f(),O(w,{key:0,size:"small",type:"danger",onClick:i},{default:_(()=>[...t[3]||(t[3]=[D(" 停止 ",-1)])]),_:1})):q("",!0)])])]),a(ge,{ref_key:"taskReplayDrawerRef",ref:n},null,512),a(Je,{ref_key:"taskInfoDrawerRef",ref:d},null,512)],2)}}}),lt=I(ot,[["__scopeId","data-v-7ced3400"]]),it={class:"stats-section"},rt={class:"stats-header"},dt={class:"date-selector"},ut={class:"current-date-range"},ct={class:"date-range-text"},mt={class:"stats-grid"},_t={class:"stat-card"},pt={class:"stat-icon running"},ft={class:"stat-content"},vt={class:"stat-number"},gt={class:"stat-card"},yt={class:"stat-icon success"},kt={class:"stat-content"},Yt={class:"stat-number"},ht={class:"stat-card"},Dt={class:"stat-icon failed"},$t={class:"stat-content"},Mt={class:"stat-number"},bt={class:"stat-card"},wt={class:"stat-icon waiting"},zt={class:"stat-content"},Tt={class:"stat-number"},xt={class:"custom-date-dialog"},Ct={class:"date-picker-row"},Vt={class:"dialog-footer"},Ht=R({__name:"TaskStats",setup(T){const r=b({}),n=S(()=>r.value.running||0+r.value.success||0+r.value.failed||0),d=b("today"),l=b(null),u=b(!1),M=S(()=>{if(d.value==="custom"){if(l.value&&l.value.length===2){const[t,m]=l.value;return`${t} 至 ${m}`}return"请选择时间范围"}const s=p[d.value]();return s.start&&s.end?`${s.start} 至 ${s.end}`:"全部时间"}),p={today:()=>{const s=v().startOf("day").format("YYYY/MM/DD HH:mm:ss"),t=v().add(1,"day").startOf("day").format("YYYY/MM/DD HH:mm:ss");return{start:s,end:t}},yesterday:()=>{const s=v().subtract(1,"day").startOf("day").format("YYYY/MM/DD HH:mm:ss"),t=v().startOf("day").format("YYYY/MM/DD HH:mm:ss");return{start:s,end:t}},week:()=>{const s=v().startOf("week").format("YYYY/MM/DD HH:mm:ss"),t=v().add(1,"week").startOf("week").format("YYYY/MM/DD HH:mm:ss");return{start:s,end:t}},month:()=>{const s=v().startOf("month").format("YYYY/MM/DD HH:mm:ss"),t=v().add(1,"month").startOf("month").format("YYYY/MM/DD HH:mm:ss");return{start:s,end:t}},all:()=>({start:void 0,end:void 0})},i=s=>{if(console.log("Date range changed to:",s),s==="custom"){u.value=!0;return}try{const t=p[s]();y(t.start,t.end)}catch(t){console.error("Error in handleDateRangeChange:",t)}},c=()=>{u.value=!1,d.value="today",l.value=null},o=()=>{if(l.value&&l.value.length===2){const[s,t]=l.value;y(s,t),u.value=!1}};async function y(s,t){const m={};s&&(m.startTime=s),t&&(m.endTime=t);const w=await j.get("/task/summarize",{params:m});r.value=w.data}return N(()=>{const s=p.today();y(s.start,s.end)}),(s,t)=>{const m=g("el-option"),w=g("el-select"),k=g("el-date-picker"),C=g("el-button"),V=g("el-dialog");return f(),Y(E,null,[e("div",it,[e("div",rt,[e("div",dt,[e("div",ut,[t[3]||(t[3]=e("span",{class:"date-range-label"},"当前范围：",-1)),e("span",ct,$(M.value),1)]),a(w,{modelValue:d.value,"onUpdate:modelValue":t[0]||(t[0]=h=>d.value=h),onChange:i,size:"small",style:{width:"120px"}},{default:_(()=>[a(m,{label:"今天",value:"today"}),a(m,{label:"昨天",value:"yesterday"}),a(m,{label:"本周",value:"week"}),a(m,{label:"本月",value:"month"}),a(m,{label:"全部",value:"all"}),a(m,{label:"定制",value:"custom"})]),_:1},8,["modelValue"])])]),e("div",mt,[e("div",_t,[e("div",pt,[a(z,{name:"mdiPlayCircle",size:"large"})]),e("div",ft,[e("div",vt,$(r.value.running||0),1),t[4]||(t[4]=e("div",{class:"stat-label"},"执行中",-1))])]),e("div",gt,[e("div",yt,[a(z,{name:"mdiCheckCircle",size:"large"})]),e("div",kt,[e("div",Yt,$(r.value.success||0),1),t[5]||(t[5]=e("div",{class:"stat-label"},"已完成",-1))])]),e("div",ht,[e("div",Dt,[a(z,{name:"mdiCloseCircle",size:"large"})]),e("div",$t,[e("div",Mt,$(r.value.failed||0),1),t[6]||(t[6]=e("div",{class:"stat-label"},"执行失败",-1))])]),e("div",bt,[e("div",wt,[a(z,{name:"mdiClock",size:"large"})]),e("div",zt,[e("div",Tt,$(n.value),1),t[7]||(t[7]=e("div",{class:"stat-label"},"全部",-1))])])])]),a(V,{modelValue:u.value,"onUpdate:modelValue":t[2]||(t[2]=h=>u.value=h),title:"选择日期范围",width:"640px","before-close":c},{footer:_(()=>[e("div",Vt,[a(C,{onClick:c},{default:_(()=>[...t[9]||(t[9]=[D("取消",-1)])]),_:1}),a(C,{type:"primary",onClick:o,disabled:!l.value||l.value.length!==2},{default:_(()=>[...t[10]||(t[10]=[D(" 确定 ",-1)])]),_:1},8,["disabled"])])]),default:_(()=>[e("div",xt,[e("div",Ct,[t[8]||(t[8]=e("label",{class:"date-label"},"时间范围：",-1)),a(k,{modelValue:l.value,"onUpdate:modelValue":t[1]||(t[1]=h=>l.value=h),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY/MM/DD HH:mm:ss","value-format":"YYYY/MM/DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue"])])])]),_:1},8,["modelValue"])],64)}}}),Rt=I(Ht,[["__scopeId","data-v-b82b673c"]]),It={class:"filter-section"},St={class:"form-content"},Ot=R({__name:"TaskFilter",props:{modelValue:{},modelModifiers:{}},emits:Q(["query"],["update:modelValue"]),setup(T,{emit:r}){const n=G(T,"modelValue"),d=[{text:"今天",value:()=>{const p=v().format("YYYY-MM-DD 00:00:00"),i=v().add(1,"day").format("YYYY-MM-DD 00:00:00");return[p,i]}},{text:"昨天",value:()=>{const p=v().subtract(1,"day").format("YYYY-MM-DD 00:00:00"),i=v().format("YYYY-MM-DD 00:00:00");return[p,i]}},{text:"前天",value:()=>{const p=v().subtract(2,"day").format("YYYY-MM-DD 00:00:00"),i=v().subtract(1,"day").format("YYYY-MM-DD 00:00:00");return[p,i]}},{text:"本周",value:()=>{const p=v().startOf("week").format("YYYY-MM-DD 00:00:00"),i=v().add(1,"week").startOf("week").format("YYYY-MM-DD 00:00:00");return[p,i]}},{text:"本月",value:()=>{const p=v().startOf("month").format("YYYY-MM-DD 00:00:00"),i=v().add(1,"month").startOf("month").format("YYYY-MM-DD 00:00:00");return[p,i]}}],l=r,u=()=>{l("query")},M=()=>{n.value.name="",n.value.status="";const p=v().format("YYYY-MM-DD 00:00:00"),i=v().add(1,"day").format("YYYY-MM-DD 00:00:00");n.value.dateRange=[p,i]};return N(()=>M()),(p,i)=>{const c=g("el-input"),o=g("el-form-item"),y=g("el-option"),s=g("el-select"),t=g("el-date-picker"),m=g("el-button"),w=g("el-form");return f(),Y("div",It,[a(w,{model:n.value,class:"filter-form"},{default:_(()=>[e("div",St,[a(o,null,{default:_(()=>[a(c,{modelValue:n.value.name,"onUpdate:modelValue":i[0]||(i[0]=k=>n.value.name=k),placeholder:"搜索任务名称...",clearable:""},{prefix:_(()=>[a(z,{name:"magnify",size:"small"})]),_:1},8,["modelValue"])]),_:1}),a(o,null,{default:_(()=>[a(s,{modelValue:n.value.status,"onUpdate:modelValue":i[1]||(i[1]=k=>n.value.status=k),placeholder:"状态筛选",clearable:"",style:{width:"320px"}},{default:_(()=>[a(y,{label:"全部",value:""}),a(y,{label:"执行中",value:"running"}),a(y,{label:"已完成",value:"success"}),a(y,{label:"执行失败",value:"failed"}),a(y,{label:"等待处理",value:"waiting"})]),_:1},8,["modelValue"])]),_:1}),a(o,null,{default:_(()=>[a(t,{modelValue:n.value.dateRange,"onUpdate:modelValue":i[2]||(i[2]=k=>n.value.dateRange=k),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",shortcuts:d},null,8,["modelValue"])]),_:1}),a(o,null,{default:_(()=>[a(m,{type:"primary",onClick:u},{default:_(()=>[a(z,{name:"mdiMagnify",size:"small"}),i[3]||(i[3]=D(" 查询 ",-1))]),_:1}),a(m,{onClick:M},{default:_(()=>[a(z,{name:"mdiFilterOutline",size:"small"}),i[4]||(i[4]=D(" 重置条件 ",-1))]),_:1})]),_:1})])]),_:1},8,["model"])])}}}),qt=I(Ot,[["__scopeId","data-v-4c5f9fe5"]]),Ut={class:"task-management-page"},Ft={class:"task-list-section"},Nt={class:"task-list"},At={key:0,class:"loading-state"},Et={key:1,class:"empty-state"},Bt={key:2,class:"task-items"},jt={key:0,class:"pagination-section"},Lt=R({__name:"index",setup(T){const r=b(!1),n=X({total:-1,page:1,size:parseInt(localStorage.getItem("page-size-task")||"10")}),d=b({sortBy:"_insertTime",sortType:"desc"}),l=b([]),u=()=>{n.page=1,n.total=-1,p()};function M(){p(),localStorage.setItem("page-size-task",""+n.size)}async function p(i=!1){i&&(n.total=-1);const c={page:n.page,size:n.size,total:n.total,criteria:JSON.stringify(d.value||{})};try{r.value=!0;const o=await j.get("/task/query",{params:c});o.data&&o.data.list?(l.value=o.data.list,n.size=o.data.size,n.page=o.data.page,n.total=o.data.total):(l.value=[],n.page=1,n.total=-1)}catch(o){console.error("获取任务数据失败:",o),U.error("获取任务数据失败")}finally{r.value=!1}}return N(()=>u()),(i,c)=>{const o=g("el-icon"),y=g("el-pagination");return f(),Y("div",Ut,[a(ee,{title:"任务管理",icon:"clipboard-list"}),a(Rt,{tasks:l.value},null,8,["tasks"]),a(qt,{modelValue:d.value,"onUpdate:modelValue":c[0]||(c[0]=s=>d.value=s),onQuery:u},null,8,["modelValue"]),e("div",Ft,[c[6]||(c[6]=e("div",{class:"list-header"},[e("h3",{class:"list-title"},"任务列表")],-1)),e("div",Nt,[r.value?(f(),Y("div",At,[a(o,{class:"is-loading"},{default:_(()=>[a(z,{name:"mdiLoading"})]),_:1}),c[3]||(c[3]=e("span",null,"加载中...",-1))])):l.value.length===0?(f(),Y("div",Et,[a(z,{name:"clipboard-list-outline",size:"xlarge",class:"empty-icon"}),c[4]||(c[4]=e("h3",null,"暂无任务",-1)),c[5]||(c[5]=e("p",null,"当前没有找到符合条件的任务",-1))])):(f(),Y("div",Bt,[(f(!0),Y(E,null,Z(l.value,s=>(f(),O(lt,{key:s._id,task:s},null,8,["task"]))),128))]))]),n.total>0?(f(),Y("div",jt,[n.total>0?(f(),O(y,{key:0,"current-page":n.page,"onUpdate:currentPage":c[1]||(c[1]=s=>n.page=s),"page-size":n.size,"onUpdate:pageSize":c[2]||(c[2]=s=>n.size=s),total:n.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:M,onCurrentChange:p},null,8,["current-page","page-size","total"])):q("",!0)])):q("",!0)])])}}}),Xt=I(Lt,[["__scopeId","data-v-aa1f933a"]]);export{Xt as default};
